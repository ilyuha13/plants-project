// ============================================
// FINAL DATABASE SCHEMA - Plants Project
// ============================================
// Финальная схема с учетом упрощенного MVP

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url = env("DATABASE_URL")
}

// ============================================
// ПОЛЬЗОВАТЕЛИ И АВТОРИЗАЦИЯ
// ============================================

model User {
    id String @id @default(uuid())
    nick String @unique
    password String // bcrypt hash (не SHA256!)
    createdAt DateTime @default(now())
    role Role @default(USER)

    // Связи
    cart Cart?
    orders Order[]

    passwordResetTokens PasswordResetToken[]

    @@index([role])
}

enum Role {
    ADMIN
    USER
}

model PasswordResetToken {
    id        String   @id @default(uuid())
    token     String   @unique @default(uuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    expiresAt DateTime
    used      Boolean  @default(false)
    createdAt DateTime @default(now())

    @@index([token])
    @@index([userId])
}

// ============================================
// СПРАВОЧНИКИ (для фильтрации)
// ============================================

model Genus {
    id String @id @default(uuid())
    name String @unique
    description String?
    imagesUrl String[]
    plants Plant[]
    createdAt DateTime @default(now())

    @@index([name])
}

model Variegation {
    id String @id @default(uuid())
    name String @unique
    description String?
    imagesUrl String[]
    plants Plant[]
    createdAt DateTime @default(now())

    @@index([name])
}

model LifeForm {
    id String @id @default(uuid())
    name String @unique
    description String?
    imagesUrl String[]
    plants Plant[]
    createdAt DateTime @default(now())

    @@index([name])
}

// ============================================
// РАСТЕНИЯ И ЭКЗЕМПЛЯРЫ
// ============================================

model Plant {
    plantId String @unique @id @default(uuid())

    genusId String
    genus Genus @relation(fields: [genusId], references: [id])

    variegationId String
    variegation Variegation @relation(fields: [variegationId], references: [id])

    lifeFormId String
    lifeForm LifeForm @relation(fields: [lifeFormId], references: [id])

    name String
    description String
    imagesUrl String[]

    plantInstances PlantInstance[]

    createdAt DateTime @default(now())

    @@index([genusId])
    @@index([variegationId])
    @@index([lifeFormId])
    @@index([name])
}

model PlantInstance {
    Id String @unique @id @default(uuid())
    inventoryNumber String @unique

    plantId String
    plant Plant @relation(fields: [plantId], references: [plantId], onDelete: Cascade)

    description String?
    imagesUrl String[]
    price String
    status PlantStatus @default(AVAILABLE)

    reservedUntil DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    cartItems CartItem[]
    orderItems OrderItem[]

    @@index([status])
    @@index([plantId])
    @@index([reservedUntil])
}

enum PlantStatus {
    AVAILABLE
    IN_CART
    SOLD
}

// ============================================
// КОРЗИНА
// ============================================

model Cart {
    id String @id @default(uuid())
    userId String @unique
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
    items CartItem[]
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model CartItem {
    id String @id @default(uuid())
    cartId String
    cart Cart @relation(fields: [cartId], references: [id], onDelete: Cascade)
    plantInstanceId String
    plantInstance PlantInstance @relation(fields: [plantInstanceId], references: [Id], onDelete: Cascade)
    addedAt DateTime @default(now())

    @@unique([cartId, plantInstanceId])
    @@index([cartId])
    @@index([plantInstanceId])
}

// ============================================
// ЗАКАЗЫ
// ============================================

model Order {
    id String @id @default(uuid())
    userId String
    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    status OrderStatus @default(PENDING)

    items OrderItem[]

    customerName String
    customerPhone String
    customerAddress String?

    vkContact String?
    telegramContact String?

    customerNotes String?

    totalAmount String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([userId])
    @@index([status])
    @@index([createdAt])
}

enum OrderStatus {
    PENDING
    AWAITING_PAYMENT
    COLLECTING
    PACKED
    SHIPPED
    DELIVERED
    CANCELLED
}

model OrderItem {
    id String @id @default(uuid())
    orderId String
    order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

    plantInstanceId String
    plantInstance PlantInstance @relation(fields: [plantInstanceId], references: [Id])

    @@index([orderId])
    @@index([plantInstanceId])
}
